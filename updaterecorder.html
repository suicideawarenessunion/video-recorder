<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Video Recorder</title>

<style>
  body { 
    font-family: sans-serif; 
    padding: 0; 
    margin: 0; 
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #f8f8f8;
    height: 100vh;
  }

  h2 { margin: 10px 0; }

  video {
    width: 100%;
    height: calc(100vh - 210px);
    object-fit: cover;
    background: black;
  }

  .controls {
    display: flex;
    gap: 10px;
    margin: 10px 0;
  }

  button { 
    padding: 12px 18px; 
    font-size: 16px; 
    cursor: pointer;
  }

  #toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 4px;
    padding: 16px;
    position: fixed;
    z-index: 1;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    font-size: 17px;
  }

  #toast.show {
    visibility: visible;
    animation: fadein 0.5s, fadeout 0.5s 2.5s;
  }

  @keyframes fadein {
    from { bottom: 0; opacity: 0; }
    to { bottom: 30px; opacity: 1; }
  }

  @keyframes fadeout {
    from { bottom: 30px; opacity: 1; }
    to { bottom: 0; opacity: 0; }
  }
</style>
</head>

<body>

<h2>Video Recorder</h2>

<video id="preview" autoplay muted playsinline></video>

<div class="controls">
  <button id="flipBtn">ðŸ”„ Flip Camera</button>
  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>
</div>

<div id="toast"></div>

<script>
let mediaRecorder;
let recordedChunks = [];
let currentStream;
let currentFacing = "environment"; // default back camera

const params = new URLSearchParams(window.location.search);
const userEmail = params.get("email");
const userName  = params.get("name");

function showToast(msg) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.className = "show";
  setTimeout(() => toast.className = "", 3000);
}

async function startCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(t => t.stop());
  }

  currentStream = await navigator.mediaDevices.getUserMedia({
    audio: true,
    video: { facingMode: { ideal: currentFacing } }
  });

  document.getElementById("preview").srcObject = currentStream;

  // mirror only for front cam
  document.getElementById("preview").style.transform =
    currentFacing === "user" ? "scaleX(-1)" : "scaleX(1)";
}

// initial camera load
startCamera();

// Flip Camera
document.getElementById("flipBtn").onclick = async () => {
  currentFacing = currentFacing === "user" ? "environment" : "user";
  await startCamera();
};

// Start Recording
document.getElementById("startBtn").onclick = () => {
  recordedChunks = [];
  mediaRecorder = new MediaRecorder(currentStream);

  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) recordedChunks.push(e.data);
  };

  mediaRecorder.start();
  startBtn.disabled = true;
  stopBtn.disabled = false;
};

// Stop Recording
document.getElementById("stopBtn").onclick = () => {
  mediaRecorder.stop();
  currentStream.getTracks().forEach(track => track.stop());

  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: "video/mp4" });
    const reader = new FileReader();

    reader.onloadend = () => {
      const base64Data = reader.result.split(",")[1];

      fetch("https://3299cb60efafe263a7276ab328834e.db.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/fdc29afcdd694b40acdfb4c8a390f396/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=dIr_nWcIIg-KB8nw5c7A7c8D3cmi5zWbTE9j8RzT1Xo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          filename: "video_" + Date.now() + ".mp4",
          filedata: base64Data,
          userEmail,
          userName
        })
      })
      .then(() => showToast("Video uploaded successfully!"))
      .catch(() => showToast("Upload failed"));
    };

    reader.readAsDataURL(blob);
  };

  startBtn.disabled = false;
  stopBtn.disabled = true;
};
</script>

</body>
</html>
