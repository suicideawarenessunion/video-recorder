<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Video Recorder</title>

<style>
  body { 
    font-family: sans-serif; 
    margin: 0; 
    background: #000;
    height: 100vh;
    overflow: hidden;
  }

  h2 {
    color: #fff;
    text-align: center;
    margin: 10px 0;
  }

  .camera-container {
    position: relative;
    width: 100%;
    height: calc(100vh - 120px);
  }

  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: black;
  }

  /* ðŸ”„ Flip icon overlay */
  #flipBtn {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 10;
    background: rgba(0,0,0,0.6);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    font-size: 22px;
    cursor: pointer;
  }

  .controls {
    display: flex;
    justify-content: center;
    gap: 20px;
    padding: 10px;
    background: #111;
  }

  button.control-btn {
    padding: 12px 24px;
    font-size: 16px;
    cursor: pointer;
  }

  #toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 4px;
    padding: 16px;
    position: fixed;
    z-index: 20;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    font-size: 16px;
  }

  #toast.show {
    visibility: visible;
  }
</style>
</head>

<body>

<h2>Video Recorder</h2>

<div class="camera-container">
  <video id="preview" autoplay muted playsinline></video>
  <!-- ðŸ”„ ONE TAP FLIP ICON -->
  <button id="flipBtn">ðŸ”„</button>
</div>

<div class="controls">
  <button id="startBtn" class="control-btn">Start</button>
  <button id="stopBtn" class="control-btn" disabled>Stop</button>
</div>

<div id="toast"></div>

<script>
let mediaRecorder;
let recordedChunks = [];
let currentStream;
let currentFacing = "environment"; // back cam default

const params = new URLSearchParams(window.location.search);
const userEmail = params.get("email");
const userName  = params.get("name");

function showToast(msg) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.className = "show";
  setTimeout(() => toast.className = "", 3000);
}

async function startCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(t => t.stop());
  }

  currentStream = await navigator.mediaDevices.getUserMedia({
    audio: true,
    video: { facingMode: { ideal: currentFacing } }
  });

  const preview = document.getElementById("preview");
  preview.srcObject = currentStream;

  // mirror only front camera
  preview.style.transform =
    currentFacing === "user" ? "scaleX(-1)" : "scaleX(1)";
}

// initial load
startCamera();

// ðŸ”„ ONE TAP FLIP (same symbol)
document.getElementById("flipBtn").onclick = async () => {
  currentFacing = currentFacing === "user" ? "environment" : "user";
  await startCamera();
};

// â–¶ï¸ Start Recording
document.getElementById("startBtn").onclick = () => {
  recordedChunks = [];
  mediaRecorder = new MediaRecorder(currentStream);

  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) recordedChunks.push(e.data);
  };

  mediaRecorder.start();
  startBtn.disabled = true;
  stopBtn.disabled = false;
};

// â¹ Stop Recording
document.getElementById("stopBtn").onclick = () => {
  mediaRecorder.stop();
  currentStream.getTracks().forEach(track => track.stop());

  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: "video/mp4" });
    const reader = new FileReader();

    reader.onloadend = () => {
      const base64Data = reader.result.split(",")[1];

      fetch("https://3299cb60efafe263a7276ab328834e.db.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/334d4c7c43fc45cfb26d29910cf613d2/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=85YJTElGV4e568r9HA58gkQExjZequ_P3KOXOVuo5Wo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          filename: "video_" + Date.now() + ".mp4",
          filedata: base64Data,
          userEmail,
          userName
        })
      })
      .then(() => showToast("Video uploaded successfully!"))
      .catch(() => showToast("Upload failed"));
    };

    reader.readAsDataURL(blob);
  };

  startBtn.disabled = false;
  stopBtn.disabled = true;
};
</script>

</body>
</html>
